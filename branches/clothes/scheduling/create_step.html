{% extends "search.html" %}

{% block searchField %}		  		
			
{% endblock %}		  			

{% block table_head %}		  
<style>
#working{

color:white;
background-color:#7A942E;
border-radius: 5px;
box-shadow: 1px 1px 1px #888;
	font-family:Helvetica, sans-serif;
	font-size:11px;
}

#pending{

color:white;
background-color:#857C55;
border-radius: 5px;
box-shadow: 1px 1px 1px #888;
	font-family:Helvetica, sans-serif;
	font-size:11px;	
	
}

#complete{
background-color:#317589;
color:white;
box-shadow: 1px 1px 1px #888;
border-radius: 5px;
	font-family:Helvetica, sans-serif;
	font-size:11px;	
}

</style>
            <thead>  
              <tr>
                <td colspan=6>
                <span class="date"><label for="id_start_date">Start Date: </label> </span><span class="date"> <input id="id_start_date" type="text" class="vDateField" name="start_date" size="10"/> </span><span class="date"> <label for="id_end_date">End Date: </label> </span><span class="date"> <input id="id_end_date" type="text" class="vDateField" name="end_date" size="10"/></span>
                Step: <select name="task_pk" id="task_pk"> 
                {% for task in tasks %}
                    <option value="{{task.pk}}">{{task.name}}</option>
                {% endfor %}
                </select></td>
              </tr>
              <tr>
                <td colspan=6>
                Jobs: {{job.name}}: {{job.description}}   					<a target="_blank" href="/admin/scheduling/job/{{job.pk}}/"><img style="padding-right:10px" src="/static/images/edit.png" width="20" height="20"></a>
<br/>
                {{job.start_at|date:"Y/m/d"}} - {{job.end_at|date:"Y/m/d"}} <br/>
		<h1>{{progress}}%</h1>
                                           
                <div id=""><a href="/workflow/step/prevstep/{{job.pk}}/"><img src="/static/images/arrow_left.png" ></a>{{step.status}}<a href="/workflow/step/nextstep/{{job.pk}}/"><img src="/static/images/arrow_down.png"></a></div>
                		
		
                </td>
              </tr>              
              <tr>  
                <th style="width:100px;">Status
                </th>  
                <th style="width:auto">Task
                </th>				  
                <th style="width:auto;">Worker
                </th>  
                <th style="width:auto;">Cost
                </th>  
                <th style="width:auto;">Loading
                </th>                  
                <th style="width:auto">Action
                </th>                  
              </tr>  
	      {% for step in job.steps %}

                    <tr><td>
					{%ifequal step.status "Working"%}
						<div id="working">{{step.status}}</div> 
					{%endifequal%}	
					
					{%ifequal step.status "Complete"%}				
						 <div id="complete"> {{step.status}} </div></div>
					{%endifequal%}
					

					{%ifequal step.status "Pending"%}				
						 <div id="pending">{{step.status}}</div></div>
					{%endifequal%}
					

					
					</td><td>{{step.task}}<br/>{{step.start_at|date:"Y/m/d"}} - {{step.end_at|date:"Y/m/d"}} </td><td> {{step.worker}} </td><td class="cost"> {{step.cost}} </td><td class="loading" id="{{step.worker.pk}}_loading_confirm">0</td><td>
					
					<a target="_blank" href="/admin/scheduling/step/{{step.pk}}/"><img style="padding-right:10px" src="/static/images/edit.png" width="20" height="20"></a>
					
					<a href="/workflow/step/remove/{{job.pk}}/{{step.pk}}/"><img src="/static/images/delete_task.png" width="20" height="20"></a></td></tr>
                {% endfor %}
                    <tr><td></td><td></td><td style="font-weight: bolder">Total Cost:</td><td id="summary_cost"> 0 </td><td id="summary_loading"></td><td></td></tr>              
                <tr><th colspan=6> Available Worker </th></tr>
            </thead>
	
			<div>
			

		
			
{% endblock %}	
{% block sell_detail %}

{% endblock %}
{% block table_script %}
    var myDate = new Date();
    var prettyDate = myDate.getFullYear() + '-' +(myDate.getMonth()+1) + '-' + myDate.getDate();
    $("#id_start_date").val(prettyDate);
    $("#id_end_date").val(prettyDate);
	
    $("#task_pk,#id_start_date,#id_end_date").click(function(){
                        $.ajax({
                            url: "/workflow/task/worker/list/"+$("#task_pk").val()+ "?start_date=" + $("#id_start_date").val()+ "&end_date=" + $("#id_end_date").val(),
                            type: "JSON",
                            success: function(data){  
                                row = '';
                                for(i=0 ; i < data.length; i++){
                                    row += _genRowByPK(data[i]);
                                }
                                
                                $('#sell_detail').html(row);	
                            },
                            error: function(data){ },
                            complete: function(data){},
                        });       
                        
						
						
						
                        $.ajax({
                            url: "/workflow/worker/loading?start_date=" + $("#id_start_date").val()+ "&end_date=" + $("#id_end_date").val(),
                            type: "JSON",
                            success: function(data){  
                                
                                for(i=0 ; i < data.length; i++){
                                    dict = data[i]
                                    for(key in dict){
                                        pk = key
                                        v = dict[key]
                                        $("#"+pk+"_loading_confirm").text(v)
                                        $("#"+pk+"_loading").text(v)
                                    }
                                }
                            },
                            error: function(data){ alert("Product Not found! please check your barcode: " + $("#customer").val()) },
                            complete: function(data){},
                        });                               
    
    });
    
    $("#id_start_date").datepicker({dateFormat: 'yy-mm-dd'});
	$("#id_start_date").click( function() {
		$('#sell_detail').empty();
		var start = $.datepicker.parseDate('yy-mm-dd', $("#id_start_date").val());
		var end = '';
		if($("#id_end_date").val() == ''){
			end = $.datepicker.parseDate('yy-mm-dd', $("#id_start_date").val());
		}else{
			end = $.datepicker.parseDate('yy-mm-dd', $("#id_end_date").val());
		}
		
		filterByDate(start, end);
	  }
	);
	$("#id_end_date").datepicker({dateFormat: 'yy-mm-dd'});
	$("#id_end_date").click( function() {
	  $('#sell_detail').empty();
		var start = '';
		var end = $.datepicker.parseDate('yy-mm-dd', $("#id_end_date").val());
		if($("#id_start_date").val() == ''){
			start = $.datepicker.parseDate('yy-mm-dd', $("#id_end_date").val());
		}else{
			start = $.datepicker.parseDate('yy-mm-dd', $("#id_start_date").val());
		}
	  filterByDate(start, end);
	});	

	function filterByDate(start, end){
	}
{% endblock %}	


{% block table_content %}	
    function _submit(job_pk, task_pk, worker_pk){
        cost = $("#"+ worker_pk +"_cost").val();
        date_range = "?start_date="+$("#id_start_date").val()+"&end_date="+$("#id_end_date").val()
        link = "/workflow/step/save/" + job_pk + "/" + task_pk + "/" + worker_pk + "/" + cost + "/" + date_range;
        $("#choosed_worker_"+worker_pk).attr("href",link);
        return true;
    };
    
    function _genRowByPK(data){
        job_pk = {{job.pk}}
        task_pk = $("#task_pk").val()
        worker_pk = data.fields.worker.split("@")[1]
        cost = data.fields.cost
        worker_cost_id = worker_pk+"_cost"
        row = ""+
                "<tr>"+
                "<td>"+data.pk+"</td>"+
                "<td>"+data.fields.task+"</td>"+
                "<td>"+data.fields.worker.split("@")[0]+"</td>"+
                "<td><input type=text size=3 id='"+ worker_cost_id +"' value="+ cost +" /></td>"+
                "<td id='"+data.fields.worker.split("@")[1]+"_loading'>0</td>"+
                "<td><a id='choosed_worker_" + worker_pk + "' href='' onClick='_submit(" + job_pk + "," + task_pk + "," + worker_pk + ")'><img src='/static/images/choose.png' width='20' height='20'></a></td>"+                
                "</tr>";    
                
        return row;
    };
    
{% endblock %}

    {% block jquery_ready %}
        function calc_summary_cost() {
            var total_cost = 0;
            var x = $(".cost")
            $(".cost").each(function(idx, obj){
                total_cost += parseFloat($(obj).text());
            });
            $("#summary_cost").html(total_cost.toFixed(2));
        };    
        calc_summary_cost();
    {% endblock %}          

